{% extends "base.html" %}
{% block title %}Edit Resource{% endblock %}
{% block content %}
<div class="bg-white shadow-xl rounded-xl p-8 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Edit Resource</h1>
    
    <form method="POST" action="{{ url_for('resources.edit_resource', resource_id=resource.resource_id) }}" enctype="multipart/form-data" class="space-y-6">
        {{ form.hidden_tag() }}
        
        <div>
            {{ form.title.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
            {{ form.title(class_='w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500') }}
            {% for error in form.title.errors %}
                <p class="text-sm text-red-600 mt-1">{{ error }}</p>
            {% endfor %}
        </div>

        <div>
            {{ form.description.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
            {{ form.description(class_='w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500') }}
            {% for error in form.description.errors %}
                <p class="text-sm text-red-600 mt-1">{{ error }}</p>
            {% endfor %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                {{ form.category.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
                {{ form.category(class_='w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500') }}
                {% for error in form.category.errors %}
                    <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <div>
                {{ form.location.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
                {{ form.location(class_='w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500') }}
                {% for error in form.location.errors %}
                    <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                {{ form.capacity.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
                {{ form.capacity(class_='w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500', type='number', min='1') }}
                {% for error in form.capacity.errors %}
                    <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <div>
                {{ form.status.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
                {{ form.status(class_='w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500') }}
                {% for error in form.status.errors %}
                    <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
            </div>
        </div>

        <div>
            {{ form.booking_type.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
            {{ form.booking_type(class_='w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500') }}
            {% if form.booking_type.description %}
            <p class="text-xs text-gray-500 mt-1">{{ form.booking_type.description }}</p>
            {% endif %}
            {% for error in form.booking_type.errors %}
                <p class="text-sm text-red-600 mt-1">{{ error }}</p>
            {% endfor %}
        </div>

        <div>
            {{ form.equipment.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
            {{ form.equipment(class_='w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500') }}
            <p class="text-xs text-gray-500 mt-1">Separate multiple items with commas</p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Current Images</label>
            {% if resource.images %}
                <div class="mb-2">
                    {% for img_path in resource.images.split(',') %}
                        <img src="{{ img_path.strip() }}" alt="Resource image" class="inline-block w-20 h-20 object-cover rounded mr-2 mb-2"
                             onerror="this.onerror=null; this.style.display='none';">
                    {% endfor %}
                </div>
            {% endif %}
            {{ form.images.label(class_='block text-sm font-medium text-gray-700 mb-1') }}
            {{ form.images(class_='w-full p-3 border border-gray-300 rounded-lg') }}
            <p class="text-xs text-gray-500 mt-1">Upload new images to add to existing ones</p>
        </div>

        <!-- Availability Calendar -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Availability Schedule</label>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-300">
                <div class="mb-4">
                    <label class="block text-xs text-gray-600 mb-2">Select Days of Week:</label>
                    <div class="flex flex-wrap gap-2">
                        {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="checkbox" name="availability_days" value="{{ day }}" 
                                   class="availability-day-checkbox"
                                   {% if availability_data and availability_data.get('days') and day in availability_data.get('days', []) %}checked{% endif %}>
                            <span class="text-sm text-gray-700">{{ day[:3] }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Start Time</label>
                        <input type="time" name="availability_start_time" 
                               value="{{ availability_data.get('start_time', '') if availability_data else '' }}"
                               class="w-full p-2 border border-gray-300 rounded">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">End Time</label>
                        <input type="time" name="availability_end_time" 
                               value="{{ availability_data.get('end_time', '') if availability_data else '' }}"
                               class="w-full p-2 border border-gray-300 rounded">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Select the days and time range when this resource is available</p>
            </div>
            <input type="hidden" name="availability_rules" id="availability_rules_json">
        </div>

        <div class="flex gap-4">
            {{ form.submit(class_='flex-1 bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150') }}
            <a href="{{ url_for('resources.resource_detail', resource_id=resource.resource_id) }}" class="flex-1 bg-gray-300 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-400 text-center">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Convert calendar selections to JSON format
document.querySelector('form').addEventListener('submit', function(e) {
    const days = Array.from(document.querySelectorAll('.availability-day-checkbox:checked')).map(cb => cb.value);
    const startTime = document.querySelector('input[name="availability_start_time"]').value;
    const endTime = document.querySelector('input[name="availability_end_time"]').value;
    
    if (days.length > 0 && startTime && endTime) {
        const availabilityRules = {
            days: days,
            start_time: startTime,
            end_time: endTime
        };
        document.getElementById('availability_rules_json').value = JSON.stringify(availabilityRules);
    }
});
</script>
{% endblock %}

