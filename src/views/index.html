{% extends "base.html" %}
{% block title %}Home - Resource Search{% endblock %}
{% block content %}
<style>
    /* Hide number input spinners */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }
</style>
<div class="flex flex-col md:flex-row gap-6 min-h-screen">
    <!-- Left Sidebar - Filters (40% width) -->
    <aside class="w-full md:w-2/5 lg:w-2/5 bg-white shadow-lg rounded-lg p-6 h-fit md:sticky md:top-20">
        <!-- Filters Header -->
        <div class="bg-indigo-600 text-white px-4 py-3 rounded-lg mb-6">
            <h2 class="text-lg font-bold">Filters</h2>
        </div>
        
        <!-- Filter Form -->
        <form action="{{ url_for('resources.list_resources') }}" method="GET" class="space-y-3">
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none z-10"></i>
                    <input type="text" 
                           name="q" 
                           value="{{ search_term or '' }}" 
                           class="w-full p-3 pl-14 pr-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <!-- Categories -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Categories</label>
                <select name="category" id="categoryFilter" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-[url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3E%3Cpolyline points=%276 9 12 15 18 9%27%3E%3C/polyline%3E%3C/svg%3E')] bg-no-repeat bg-right pr-10">
                    <option value="">All categories</option>
                    <!-- Categories will be populated dynamically via JavaScript -->
                </select>
            </div>
            
            <!-- Location -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none z-10"></i>
                    <input type="text" 
                           name="location" 
                           value="{{ location or '' }}" 
                           placeholder="Search by location..." 
                           class="w-full p-3 pl-14 pr-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <!-- Minimum Capacity -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Capacity</label>
                <div class="flex items-center">
                    <input type="number" 
                           name="capacity" 
                           value="{{ capacity or '' }}" 
                           placeholder="e.g. 20" 
                           min="1" 
                           class="w-full p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <div class="flex flex-col border border-l-0 border-gray-300 rounded-r-lg">
                        <button type="button" onclick="incrementCapacity()" class="px-2 py-1 border-b border-gray-300 hover:bg-gray-100">
                            <i class="fas fa-chevron-up text-xs text-gray-600"></i>
                        </button>
                        <button type="button" onclick="decrementCapacity()" class="px-2 py-1 hover:bg-gray-100">
                            <i class="fas fa-chevron-down text-xs text-gray-600"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sort By -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                <select name="sort" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-[url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3E%3Cpolyline points=%276 9 12 15 18 9%27%3E%3C/polyline%3E%3C/svg%3E')] bg-no-repeat bg-right pr-10">
                    <option value="recent" {% if sort_by == 'recent' or not sort_by %}selected{% endif %}>Most Recent</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                    <option value="most_booked" {% if sort_by == 'most_booked' %}selected{% endif %}>Most Booked</option>
                    <option value="top_rated" {% if sort_by == 'top_rated' %}selected{% endif %}>Top Rated</option>
                </select>
            </div>
            
            <!-- Advanced Search -->
            <div class="flex items-center gap-2 pt-2">
                <input type="checkbox" id="advanced" name="advanced" value="true" class="w-4 h-4 text-indigo-600">
                <label for="advanced" class="text-sm text-gray-700">Use Advanced Search (Semantic)</label>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 font-semibold transition">
                Apply Filters
            </button>
            
            <!-- Clear Filters Button -->
            <a href="{{ url_for('resources.list_resources') }}" 
               class="block w-full bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 font-semibold transition text-center">
                <i class="fas fa-times-circle mr-2"></i>Clear Filters
            </a>
        </form>
    </aside>
    
    <!-- Right Main Content - Resource Listings (60% width) -->
    <main class="w-full md:w-3/5 lg:w-3/5 bg-gray-50 rounded-lg p-6">
        <!-- Content Header -->
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
                {% if resources %}
                    {% if request.args.get('show_all') == 'true' %}
                        {% if current_user.role == 'admin' %}
                            All Resources
                        {% else %}
                            My Resources
                        {% endif %}
                    {% else %}
                        Available Resources
                    {% endif %}
                {% else %}
                    Available Resources
                {% endif %}
            </h2>
            <p class="text-gray-600">Browse and book campus resources</p>
        </div>
        
        <!-- Resource Listings (Vertical List) -->
        <div class="space-y-4">
            {% if resources %}
                {% for resource in resources %}
                <!-- Resource Card - Horizontal Layout -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-3 sm:p-4 flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4 hover:shadow-lg transition">
                    <!-- Image on Left -->
                    <div class="w-full sm:w-32 h-48 sm:h-32 flex-shrink-0 rounded-lg overflow-hidden bg-gradient-to-br from-indigo-100 to-purple-100">
                        {% if resource.images %}
                            {% set first_image = get_image_url(resource.images) %}
                            {% if first_image %}
                            <img src="{{ first_image }}" 
                                 alt="{{ resource.title }}" 
                                 class="w-full h-full object-cover"
                                 loading="lazy"
                                 onerror="console.error('Image failed to load:', this.src); this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-image text-3xl text-indigo-300"></i>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-image text-3xl text-indigo-300"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Details in Middle -->
                    <div class="flex-grow min-w-0 w-full sm:w-auto">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-base sm:text-lg font-bold text-gray-900">{{ resource.title }}</h3>
                            {% if resource.is_top_rated %}
                            <span class="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">
                                <i class="fas fa-star mr-1"></i>Top Rated
                            </span>
                            {% endif %}
                        </div>
                        {% if resource.avg_rating and resource.total_reviews > 0 %}
                        <div class="flex items-center gap-1 mb-2">
                            <span class="text-yellow-500 text-sm">⭐</span>
                            <span class="text-sm font-semibold text-gray-700">{{ resource.avg_rating }}</span>
                            <span class="text-xs text-gray-500">({{ resource.total_reviews }} review{{ 's' if resource.total_reviews != 1 else '' }})</span>
                        </div>
                        {% endif %}
                        <p class="text-xs sm:text-sm text-gray-600 mb-2 sm:mb-3 line-clamp-2 sm:line-clamp-1">
                            {{ resource.description or 'Modern resource with all necessary amenities' }}
                        </p>
                        <!-- Owner Info -->
                        {% if resource.owner_name %}
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs sm:text-sm text-gray-600">Posted by</span>
                            <span class="text-xs sm:text-sm font-semibold text-gray-800">{{ resource.owner_name }}</span>
                            {% if current_user.is_authenticated and current_user.user_id != resource.owner_id %}
                            <a href="{{ url_for('messages.message_user', user_id=resource.owner_id) }}" 
                               class="text-indigo-600 hover:text-indigo-800 transition" 
                               title="Message {{ resource.owner_name }}">
                                <i class="fas fa-envelope text-xs sm:text-sm"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="flex flex-wrap items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-700">
                            {% if resource.capacity %}
                            <span class="flex items-center">
                                <i class="fas fa-users mr-1 sm:mr-2 text-indigo-600"></i>Capacity: {{ resource.capacity }}
                            </span>
                            {% endif %}
                            {% if resource.location %}
                            <span class="flex items-center">
                                <i class="fas fa-map-marker-alt mr-1 sm:mr-2 text-indigo-600"></i>{{ resource.location }}
                            </span>
                            {% endif %}
                            {% if resource.category %}
                            <span class="inline-flex items-center px-2 sm:px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">
                                {{ resource.category }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Action Buttons on Right -->
                    <div class="flex-shrink-0 w-full sm:w-auto flex flex-col sm:flex-row gap-2">
                        <button onclick="openResourceModal({{ resource.resource_id }})" 
                                class="w-full sm:w-auto bg-gray-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-gray-700 font-semibold text-center whitespace-nowrap transition shadow-md text-sm sm:text-base">
                            View Details
                        </button>
                        <a href="{{ url_for('resources.resource_detail', resource_id=resource.resource_id) }}" 
                           class="block w-full sm:w-auto bg-indigo-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-indigo-700 font-semibold text-center whitespace-nowrap transition shadow-md text-sm sm:text-base">
                            Book Resource
                        </a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="bg-white rounded-lg shadow-md p-12 text-center">
                    <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-700 mb-2">No resources found</h3>
                    <p class="text-gray-500 mb-6">Try adjusting your search filters or browse all available resources.</p>
                    {% if current_user.is_authenticated and current_user.role in ['staff', 'admin'] %}
                    <a href="{{ url_for('resources.create_resource') }}" 
                       class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Create the First Resource
                    </a>
                    {% elif not current_user.is_authenticated %}
                    <a href="{{ url_for('auth.register') }}" 
                       class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-lg">
                        <i class="fas fa-user-plus mr-2"></i>Sign Up to Add Resources
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </main>
</div>

<script>
function incrementCapacity() {
    const input = document.querySelector('input[name="capacity"]');
    const current = parseInt(input.value) || 0;
    input.value = current + 1;
}

function decrementCapacity() {
    const input = document.querySelector('input[name="capacity"]');
    const current = parseInt(input.value) || 0;
    if (current > 1) {
        input.value = current - 1;
    }
}

// Resource Detail Modal Functions
function openResourceModal(resourceId) {
    const modal = document.getElementById('resourceModal');
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = '<div class="text-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i><p class="mt-4 text-gray-600">Loading resource details...</p></div>';
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    fetch(`/resources/${resourceId}/json`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                modalContent.innerHTML = `<div class="text-center py-12"><p class="text-red-600">${data.error}</p></div>`;
                return;
            }
            
            let imagesHtml = '';
            if (data.images && data.images.length > 0) {
                imagesHtml = `<div class="mb-4">
                    <img src="${data.images[0]}" alt="${data.title}" class="w-full h-64 object-cover rounded-lg shadow-md" 
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%23ddd\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'18\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage not found%3C/text%3E%3C/svg%3E';">
                </div>`;
            } else {
                imagesHtml = `<div class="w-full h-64 bg-gray-200 rounded-lg mb-4 flex items-center justify-center">
                    <span class="text-gray-400">No image available</span>
                </div>`;
            }
            
            let equipmentHtml = '';
            if (data.equipment && data.equipment.length > 0) {
                equipmentHtml = `<div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2">Equipment:</h3>
                    <div class="flex flex-wrap gap-2">
                        ${data.equipment.map(item => `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">${escapeHtml(item)}</span>`).join('')}
                    </div>
                </div>`;
            }
            
            let reviewsHtml = '';
            if (data.reviews && data.reviews.length > 0) {
                reviewsHtml = `<div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2">Reviews (${data.rating_stats.total_reviews}):</h3>
                    <div class="mb-2">
                        <span class="text-2xl font-bold">${data.rating_stats.avg_rating}</span>
                        <span class="text-yellow-500 text-lg">⭐</span>
                    </div>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${data.reviews.map(review => `
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-semibold text-gray-700">User ${review.reviewer_id}</span>
                                    <span class="text-yellow-500">${'⭐'.repeat(review.rating)}</span>
                                </div>
                                <p class="text-sm text-gray-600">${escapeHtml(review.comment)}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            } else {
                reviewsHtml = '<p class="text-gray-500 text-sm mb-4">No reviews yet.</p>';
            }
            
            modalContent.innerHTML = `
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">${escapeHtml(data.title)}</h2>
                    <div class="flex flex-wrap items-center gap-2 mb-4">
                        <span class="text-indigo-600 font-semibold">${escapeHtml(data.location || 'Location not specified')}</span>
                        ${data.capacity ? `<span class="text-gray-500">| Capacity: ${data.capacity}</span>` : ''}
                        ${data.category ? `<span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">${escapeHtml(data.category)}</span>` : ''}
                        ${data.booking_type === 'restricted' ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">Requires Approval</span>' : ''}
                    </div>
                    ${imagesHtml}
                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Description:</h3>
                        <p class="text-gray-600 text-sm">${escapeHtml(data.description)}</p>
                    </div>
                    ${equipmentHtml}
                    ${reviewsHtml}
                    <div class="flex gap-3 mt-6 pt-4 border-t">
                        <a href="/resources/${data.resource_id}" 
                           class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-semibold text-center transition">
                            View Full Page
                        </a>
                        <a href="/bookings/create/${data.resource_id}" 
                           class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold text-center transition">
                            Book Resource
                        </a>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching resource details:', error);
            modalContent.innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error loading resource details. Please try again.</p></div>';
        });
}

function closeResourceModal() {
    document.getElementById('resourceModal').classList.add('hidden');
    document.body.style.overflow = '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load categories dynamically
function loadCategories() {
    const categorySelect = document.getElementById('categoryFilter');
    if (!categorySelect) return;
    
    // Get current category from URL params or template variable
    const urlParams = new URLSearchParams(window.location.search);
    const currentCategory = urlParams.get('category') || '{{ category or "" }}';
    
    fetch('/resources/api/categories')
        .then(response => response.json())
        .then(data => {
            // Clear existing options except "All categories"
            categorySelect.innerHTML = '<option value="">All categories</option>';
            
            // Add categories from API
            if (data.categories && data.categories.length > 0) {
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    if (category === currentCategory) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
            // Fallback: keep the default "All categories" option
        });
}

// Close modal when clicking outside or pressing Escape
document.addEventListener('DOMContentLoaded', function() {
    // Load categories on page load
    loadCategories();
    
    const modal = document.getElementById('resourceModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeResourceModal();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeResourceModal();
            }
        });
    }
});
</script>

<!-- Resource Detail Modal -->
<div id="resourceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex-shrink-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-900">Resource Details</h2>
            <button onclick="closeResourceModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none">&times;</button>
        </div>
        <div id="modalContent" class="flex-1 overflow-y-auto p-6">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

{% endblock %}

