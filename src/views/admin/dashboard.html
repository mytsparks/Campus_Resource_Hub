{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div id="dashboard-container" class="relative">
    <!-- Header with AI Report Button -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 border-b pb-2 flex-grow w-full sm:w-auto">Admin Control Panel</h1>
        <button id="aiReportBtn" onclick="toggleAIReport()" 
                class="w-full sm:w-auto bg-indigo-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-indigo-700 font-semibold shadow-lg text-sm sm:text-base">
            <i class="fas fa-robot mr-2"></i>AI Report
        </button>
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="flex flex-col lg:flex-row gap-4 sm:gap-6">
        <!-- Stats Section (Left side, 60% when AI report is shown, 100% otherwise) -->
        <div id="stats-section" class="w-full transition-all duration-300">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white p-4 sm:p-6 shadow-xl rounded-xl border-l-4 border-yellow-500">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-3">Pending Approvals</h2>
                    <p class="text-3xl sm:text-4xl font-bold text-yellow-500">{{ stats.pending_bookings }}</p>
                    <p class="text-xs sm:text-sm text-gray-500 mt-2">Bookings awaiting review</p>
                </div>

                <div class="bg-white p-4 sm:p-6 shadow-xl rounded-xl border-l-4 border-indigo-500">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-3">Total Users</h2>
                    <p class="text-3xl sm:text-4xl font-bold text-indigo-500">{{ stats.total_users }}</p>
                    <p class="text-xs sm:text-sm text-gray-500 mt-2">Registered users</p>
                    <a href="{{ url_for('admin.manage_users') }}" class="mt-2 sm:mt-3 inline-block text-indigo-600 hover:text-indigo-700 font-medium text-xs sm:text-sm">Manage Users →</a>
                </div>

                <div class="bg-white p-4 sm:p-6 shadow-xl rounded-xl border-l-4 border-green-500">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-3">Published Resources</h2>
                    <p class="text-3xl sm:text-4xl font-bold text-green-500">{{ stats.published_resources }}</p>
                    <p class="text-xs sm:text-sm text-gray-500 mt-2">Active listings</p>
                    <a href="{{ url_for('admin.manage_resources') }}" class="mt-2 sm:mt-3 inline-block text-green-600 hover:text-green-700 font-medium text-xs sm:text-sm">Manage Resources →</a>
                </div>

                <div class="bg-white p-4 sm:p-6 shadow-xl rounded-xl border-l-4 border-blue-500">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-3">Total Reviews</h2>
                    <p class="text-3xl sm:text-4xl font-bold text-blue-500">{{ stats.total_reviews }}</p>
                    <p class="text-xs sm:text-sm text-gray-500 mt-2">User reviews</p>
                    <a href="{{ url_for('admin.moderate_reviews') }}" class="mt-2 sm:mt-3 inline-block text-blue-600 hover:text-blue-700 font-medium text-xs sm:text-sm">Moderate →</a>
                </div>
            </div>

            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mt-6 sm:mt-10 mb-4 border-b pb-1">Pending Booking Approvals</h2>
            {% if pending_bookings %}
            <div class="bg-white shadow-md rounded-lg overflow-hidden overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resource</th>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Requester</th>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Start Time</th>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">End Time</th>
                            <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for booking in pending_bookings %}
                        <tr>
                            <td class="px-3 sm:px-6 py-4">
                                <div class="text-xs sm:text-sm font-medium text-gray-900">{{ booking.title }}</div>
                                <div class="text-xs sm:text-sm text-gray-500">{{ booking.location }}</div>
                                <div class="text-xs text-gray-400 sm:hidden mt-1">
                                    {{ booking.start_datetime.strftime('%Y-%m-%d %H:%M') if booking.start_datetime else 'N/A' }} - 
                                    {{ booking.end_datetime.strftime('%H:%M') if booking.end_datetime else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-3 sm:px-6 py-4 text-xs sm:text-sm text-gray-900">{{ booking.requester_name }}</td>
                            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 hidden sm:table-cell">
                                {{ booking.start_datetime.strftime('%Y-%m-%d %H:%M') if booking.start_datetime else 'N/A' }}
                            </td>
                            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 hidden md:table-cell">
                                {{ booking.end_datetime.strftime('%Y-%m-%d %H:%M') if booking.end_datetime else 'N/A' }}
                            </td>
                            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm font-medium space-x-1 sm:space-x-2">
                                <form method="POST" action="{{ url_for('bookings.approve_booking', booking_id=booking.booking_id) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="text-green-600 hover:text-green-900 bg-transparent border-none p-0 cursor-pointer">Approve</button>
                                </form>
                                <span class="text-gray-300 hidden sm:inline">|</span>
                                <form method="POST" action="{{ url_for('bookings.reject_booking', booking_id=booking.booking_id) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="text-red-600 hover:text-red-900 bg-transparent border-none p-0 cursor-pointer" onclick="return confirm('Are you sure you want to reject this booking?');">Reject</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="bg-white p-8 shadow-md rounded-lg text-center">
                <p class="text-gray-500">No pending bookings to approve.</p>
            </div>
            {% endif %}
        </div>

        <!-- AI Report Section (Right side, 40% when shown, hidden otherwise) -->
        <div id="ai-report-section" class="hidden w-full lg:w-0 transition-all duration-300 overflow-hidden">
            <div class="bg-white shadow-xl rounded-xl p-6 h-full overflow-y-auto">
                <div id="ai-report-content">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
                        <p class="text-gray-600">Loading AI Report...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4 {
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}
.markdown-content ul {
    list-style-type: disc;
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}
.markdown-content ol {
    list-style-type: decimal;
    margin-left: 1.5rem;
    margin-bottom: 1rem;
}
.markdown-content p {
    margin-bottom: 1rem;
}
.markdown-content blockquote {
    border-left: 4px solid #6366f1;
    padding-left: 1rem;
    color: #4b5563;
    font-style: italic;
}
</style>

<script>
let aiReportVisible = false;
let summaryData = null;

function toggleAIReport() {
    const statsSection = document.getElementById('stats-section');
    const aiReportSection = document.getElementById('ai-report-section');
    const mainContent = document.getElementById('main-content');
    
    if (!aiReportVisible) {
        // Show AI report
        aiReportVisible = true;
        statsSection.classList.remove('w-full');
        statsSection.classList.add('w-full', 'lg:w-[60%]');
        aiReportSection.classList.remove('hidden', 'w-0', 'w-full');
        aiReportSection.classList.add('w-full', 'lg:w-[40%]');
        
        // Load AI report if not already loaded
        if (!summaryData) {
            loadAIReport();
        } else {
            displayAIReport(summaryData);
        }
    } else {
        // Hide AI report
        aiReportVisible = false;
        statsSection.classList.remove('w-full', 'lg:w-[60%]');
        statsSection.classList.add('w-full');
        aiReportSection.classList.remove('w-full', 'lg:w-[40%]');
        aiReportSection.classList.add('hidden', 'w-0');
    }
}

function loadAIReport() {
    const contentDiv = document.getElementById('ai-report-content');
    contentDiv.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
            <p class="text-gray-600">Generating AI Report...</p>
        </div>
    `;
    
    fetch('{{ url_for("summaries.api_summary") }}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                contentDiv.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-4"></i>
                        <p class="text-red-600">Error: ${data.error}</p>
                    </div>
                `;
            } else {
                summaryData = data;
                displayAIReport(data);
            }
        })
        .catch(error => {
            console.error('Error loading AI report:', error);
            contentDiv.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-4"></i>
                    <p class="text-red-600">Failed to load AI report. Please try again.</p>
                </div>
            `;
        });
}

function displayAIReport(data) {
    const contentDiv = document.getElementById('ai-report-content');
    const summary = data.summary;
    const summaryHtml = data.summary_html;
    const insights = data.insights;
    
    let html = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2 flex items-center">
                <i class="fas fa-robot mr-2 text-indigo-600"></i>
                AI-Generated Summary
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Generated: ${summary.generated_at ? summary.generated_at.substring(0, 19) : 'N/A'} | 
                Period: ${summary.period ? summary.period.start.substring(0, 10) + ' to ' + summary.period.end.substring(0, 10) : 'N/A'}
            </p>
        </div>
        
        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-4 mb-6 border-l-4 border-indigo-500">
            <div class="prose max-w-none text-gray-700 markdown-content text-sm">${summaryHtml || '<p>No summary available.</p>'}</div>
        </div>
        
        <h3 class="text-xl font-bold text-gray-900 mb-4">Key Insights</h3>
        <div class="grid grid-cols-1 gap-3 mb-6">
    `;
    
    if (insights && insights.insights) {
        insights.insights.slice(0, 4).forEach(insight => {
            html += `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <h4 class="font-semibold text-gray-900 mb-1 text-sm">${insight.title || 'Insight'}</h4>
                    <p class="text-xs text-gray-600">${insight.description || ''}</p>
                </div>
            `;
        });
    }
    
    html += `
        </div>
        
        <h3 class="text-xl font-bold text-gray-900 mb-4">Top Resources</h3>
        <div class="bg-gray-50 rounded-lg overflow-hidden mb-4">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Resource</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Bookings</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;
    
    if (summary.data && summary.data.top_resources) {
        summary.data.top_resources.slice(0, 5).forEach((resource, index) => {
            html += `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">
                            #${index + 1}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-900">${resource.title || 'N/A'}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900">${resource.booking_count || 0}</td>
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
        
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                <h4 class="font-semibold text-gray-900 mb-2">Booking Stats</h4>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total:</span>
                        <span class="font-semibold">${summary.data && summary.data.booking_stats ? (summary.data.booking_stats.total_bookings || 0) : 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-green-600">Approved:</span>
                        <span class="font-semibold">${summary.data && summary.data.booking_stats ? (summary.data.booking_stats.approved || 0) : 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-yellow-600">Pending:</span>
                        <span class="font-semibold">${summary.data && summary.data.booking_stats ? (summary.data.booking_stats.pending || 0) : 0}</span>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                <h4 class="font-semibold text-gray-900 mb-2">User Activity</h4>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Active Users:</span>
                        <span class="font-semibold">${summary.data && summary.data.user_activity ? (summary.data.user_activity.active_users || 0) : 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total Bookings:</span>
                        <span class="font-semibold">${summary.data && summary.data.user_activity ? (summary.data.user_activity.total_bookings || 0) : 0}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    contentDiv.innerHTML = html;
}
</script>

{% endblock %}
